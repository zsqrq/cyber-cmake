<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cyber-Cmake: Migration guide from Apollo ROS</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Cyber-Cmake
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Migration guide from Apollo ROS </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This article describes the essential changes for projects to migrate from Apollo ROS (Apollo 3.0 and before) to Apollo Cyber RT (Apollo 3.5 and after). We will be using the very first ROS project talker/listener as example to demonstrate step by step migration instruction.</p>
<h1><a class="anchor" id="autotoc_md126"></a>
Build system</h1>
<p>ROS use <code>CMake</code> as its build system but Cyber RT use <code>bazel</code>. In a ROS project, CmakeLists.txt and package.xml are required for defining build configs like build target, dependency, message files and so on. As for a Cyber RT component, a single bazel BUILD file covers. Some key build config mappings are listed below.</p>
<p>Cmake</p>
<div class="fragment"><div class="line">project(pb_msgs_example)</div>
<div class="line">add_proto_files(</div>
<div class="line">  DIRECTORY proto</div>
<div class="line">  FILES chatter.proto</div>
<div class="line">)</div>
<div class="line">## Declare a C++ executable</div>
<div class="line">add_executable(pb_talker src/talker.cpp)</div>
<div class="line">target_link_libraries(pb_talker ${catkin_LIBRARIES}pb_msgs_example_proto)</div>
<div class="line">add_executable(pb_listener src/listener.cpp)</div>
<div class="line">target_link_libraries(pb_listener ${catkin_LIBRARIES}  pb_msgs_example_proto)</div>
</div><!-- fragment --><p>Bazel</p>
<div class="fragment"><div class="line">cc_binary(</div>
<div class="line">  name = &quot;talker&quot;,</div>
<div class="line">  srcs = [&quot;talker.cc&quot;],</div>
<div class="line">  deps = [</div>
<div class="line">    &quot;//cyber&quot;,</div>
<div class="line">    &quot;//cyber/examples/proto:examples_cc_proto&quot;,</div>
<div class="line">    ],</div>
<div class="line">  )</div>
<div class="line">cc_binary(</div>
<div class="line">  name = &quot;listener&quot;,</div>
<div class="line">  srcs = [&quot;listener.cc&quot;],</div>
<div class="line">  deps = [</div>
<div class="line">    &quot;//cyber&quot;,</div>
<div class="line">    &quot;//cyber/examples/proto:examples_cc_proto&quot;,</div>
<div class="line">    ],</div>
<div class="line">  )</div>
</div><!-- fragment --><p>We can find the mapping easily from the 2 file snippets. For example, <code>pb_talker</code> and <code>src/talker.cpp</code> in cmake <code>add_executable</code> setting map to <code>name = "talker"</code> and <code>srcs = ["talker.cc"]</code> in BUILD file <code>cc_binary</code>.</p>
<h2><a class="anchor" id="autotoc_md127"></a>
Proto</h2>
<p>Apollo ROS has customized to support proto message formate that a separate section <code>add_proto_files</code> and projectName_proto(<code>pb_msgs_example_proto</code>) in <code>target_link_libraries</code> are required to send message in proto formate. For config proto message in Cyber RT, it's as simple as adding the target proto file path concantenated with name of <code>cc_proto_library</code> in <code>deps</code> setting. The <code>cc_proto_library</code> is set up in BUILD file under proto folder.</p>
<div class="fragment"><div class="line">cc_proto_library(</div>
<div class="line">  name = &quot;examples_cc_proto&quot;,</div>
<div class="line">  deps = [</div>
<div class="line">    &quot;:examples_proto&quot;,</div>
<div class="line">  ],</div>
<div class="line">)</div>
<div class="line">proto_library(</div>
<div class="line">  name = &quot;examples_proto&quot;,</div>
<div class="line">  srcs = [</div>
<div class="line">    &quot;examples.proto&quot;,</div>
<div class="line">  ],</div>
<div class="line">)</div>
</div><!-- fragment --><p>The package definition has also changed in Cyber RT. In Apollo ROS a fixed package <code>package pb_msgs;</code> is used for proto files, but in Cyber RT, the proto file path <code>package apollo.cyber.examples.proto;</code> is used instead.</p>
<h1><a class="anchor" id="autotoc_md128"></a>
Folder structure</h1>
<p>As shown below, Cyber RT remove the src folder and pull all source code in the same folder as BUILD file. BUILD file plays the same role as CMakeLists.txt plus package.xml. Both Cyber RT and Apollo ROS talker/listener example have a proto folder for message proto files but Cyber RT requires a separate BUILD file for proto folder to set up the proto library.</p>
<h2><a class="anchor" id="autotoc_md129"></a>
Apollo ROS</h2>
<ul>
<li>CMakeLists.txt</li>
<li>package.xml</li>
<li>proto<ul>
<li>chatter.proto</li>
</ul>
</li>
<li>src<ul>
<li>listener.cpp</li>
<li>talker.cpp</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md130"></a>
Cyber RT</h2>
<ul>
<li>BUILD</li>
<li>listener.cc</li>
<li>talker.cc</li>
<li>proto<ul>
<li>BUILD</li>
<li>examples.proto (with chatter message)</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md131"></a>
Update source code</h1>
<h2><a class="anchor" id="autotoc_md132"></a>
Listener</h2>
<p>Cyber RT</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cyber/cyber.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cyber/examples/proto/examples.pb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> MessageCallback(</div>
<div class="line">    <span class="keyword">const</span> std::shared_ptr&lt;apollo::cyber::examples::proto::Chatter&gt;&amp; msg) {</div>
<div class="line">  AINFO &lt;&lt; <span class="stringliteral">&quot;Received message seq-&gt; &quot;</span> &lt;&lt; msg-&gt;seq();</div>
<div class="line">  AINFO &lt;&lt; <span class="stringliteral">&quot;msgcontent-&gt;&quot;</span> &lt;&lt; msg-&gt;content();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">  <span class="comment">// init cyber framework</span></div>
<div class="line">  apollo::cyber::Init(argv[0]);</div>
<div class="line">  <span class="comment">// create listener node</span></div>
<div class="line">  <span class="keyword">auto</span> listener_node = apollo::cyber::CreateNode(<span class="stringliteral">&quot;listener&quot;</span>);</div>
<div class="line">  <span class="comment">// create listener</span></div>
<div class="line">  <span class="keyword">auto</span> listener =</div>
<div class="line">      listener_node-&gt;CreateReader&lt;apollo::cyber::examples::proto::Chatter&gt;(</div>
<div class="line">          <span class="stringliteral">&quot;channel/chatter&quot;</span>, MessageCallback);</div>
<div class="line">  apollo::cyber::WaitForShutdown();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>ROS</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;ros/ros.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;chatter.pb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> MessageCallback(<span class="keyword">const</span> boost::shared_ptr&lt;pb_msgs::Chatter&gt;&amp; msg) {</div>
<div class="line">  ROS_INFO_STREAM(<span class="stringliteral">&quot;Time: &quot;</span> &lt;&lt; msg-&gt;stamp().sec() &lt;&lt; <span class="stringliteral">&quot;.&quot;</span> &lt;&lt; msg-&gt;stamp().nsec());</div>
<div class="line">  ROS_INFO(<span class="stringliteral">&quot;I heard pb Chatter message: [%s]&quot;</span>, msg-&gt;content().c_str());</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line">  ros::init(argc, argv, <span class="stringliteral">&quot;listener&quot;</span>);</div>
<div class="line">  ros::NodeHandle n;</div>
<div class="line">  ros::Subscriber pb_sub = n.subscribe(<span class="stringliteral">&quot;chatter&quot;</span>, 1000, MessageCallback);</div>
<div class="line">  ros::spin();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>You can see easily from the two listener code above that Cyber RT provides very similar API to for developers to migrate from ROS.</p>
<ul>
<li><code>ros::init(argc, argv, "listener");</code> --&gt; <code>apollo::cyber::Init(argv[0]);</code></li>
<li><code>ros::NodeHandle n;</code> --&gt; <code>auto listener_node = apollo::cyber::CreateNode("listener");</code></li>
<li><code>ros::Subscriber pb_sub = n.subscribe("chatter", 1000, MessageCallback);</code> --&gt; <code>auto listener = listener_node-&gt;CreateReader("channel/chatter", MessageCallback);</code></li>
<li><code>ros::spin();</code> --&gt; <code>apollo::cyber::WaitForShutdown();</code></li>
</ul>
<p>Note: for Cyber RT, a listener node has to use <code>node-&gt;CreateReader&lt;messageType&gt;(channelName, callback)</code> to read data from channel.</p>
<h2><a class="anchor" id="autotoc_md133"></a>
Talker</h2>
<p>Cyber RT</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cyber/cyber.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cyber/examples/proto/examples.pb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using</span> apollo::cyber::examples::proto::Chatter;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {</div>
<div class="line">  <span class="comment">// init cyber framework</span></div>
<div class="line">  apollo::cyber::Init(argv[0]);</div>
<div class="line">  <span class="comment">// create talker node</span></div>
<div class="line">  <span class="keyword">auto</span> talker_node = apollo::cyber::CreateNode(<span class="stringliteral">&quot;talker&quot;</span>);</div>
<div class="line">  <span class="comment">// create talker</span></div>
<div class="line">  <span class="keyword">auto</span> talker = talker_node-&gt;CreateWriter&lt;Chatter&gt;(<span class="stringliteral">&quot;channel/chatter&quot;</span>);</div>
<div class="line">  Rate rate(1.0);</div>
<div class="line">  <span class="keywordflow">while</span> (apollo::cyber::OK()) {</div>
<div class="line">    <span class="keyword">static</span> uint64_t seq = 0;</div>
<div class="line">    <span class="keyword">auto</span> msg = std::make_shared&lt;Chatter&gt;();</div>
<div class="line">    msg-&gt;set_timestamp(Time::Now().ToNanosecond());</div>
<div class="line">    msg-&gt;set_lidar_timestamp(Time::Now().ToNanosecond());</div>
<div class="line">    msg-&gt;set_seq(seq++);</div>
<div class="line">    msg-&gt;set_content(<span class="stringliteral">&quot;Hello, apollo!&quot;</span>);</div>
<div class="line">    talker-&gt;Write(msg);</div>
<div class="line">    AINFO &lt;&lt; <span class="stringliteral">&quot;talker sent a message!&quot;</span>;</div>
<div class="line">    rate.Sleep();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>ROS</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;ros/ros.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;chatter.pb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line">  ros::init(argc, argv, <span class="stringliteral">&quot;talker&quot;</span>);</div>
<div class="line">  ros::NodeHandle n;</div>
<div class="line">  ros::Publisher chatter_pub = n.advertise&lt;pb_msgs::Chatter&gt;(<span class="stringliteral">&quot;chatter&quot;</span>, 1000);</div>
<div class="line">  ros::Rate loop_rate(10);</div>
<div class="line">  <span class="keywordtype">int</span> count = 0;</div>
<div class="line">  <span class="keywordflow">while</span> (ros::ok()) {</div>
<div class="line">    pb_msgs::Chatter msg;</div>
<div class="line">    ros::Time now = ros::Time::now();</div>
<div class="line">    msg.mutable_stamp()-&gt;set_sec(now.sec);</div>
<div class="line">    msg.mutable_stamp()-&gt;set_nsec(now.nsec);</div>
<div class="line">    std::stringstream ss;</div>
<div class="line">    ss &lt;&lt; <span class="stringliteral">&quot;Hello world &quot;</span> &lt;&lt; count;</div>
<div class="line">    msg.set_content(ss.str());</div>
<div class="line">    chatter_pub.publish(msg);</div>
<div class="line">    ros::spinOnce();</div>
<div class="line">    loop_rate.sleep();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Most of the mappings are illustrated in listener code above, the rest are listed here.</p>
<ul>
<li><code>ros::Publisher chatter_pub = n.advertise&lt;pb_msgs::Chatter&gt;("chatter", 1000);</code> --&gt; <code>auto talker = talker_node-&gt;CreateWriter&lt;Chatter&gt;("channel/chatter");</code></li>
<li><code>chatter_pub.publish(msg);</code> --&gt; <code>talker-&gt;Write(msg);</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md134"></a>
Tools mapping</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">ROS   </th><th class="markdownTableHeadLeft">Cyber RT   </th><th class="markdownTableHeadLeft">Note    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">rosbag   </td><td class="markdownTableBodyLeft">cyber_recorder   </td><td class="markdownTableBodyLeft">data file    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">scripts/diagnostics.sh   </td><td class="markdownTableBodyLeft">cyber_monitor   </td><td class="markdownTableBodyLeft">channel debug    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">offline_lidar_visualizer_tool   </td><td class="markdownTableBodyLeft">cyber_visualizer   </td><td class="markdownTableBodyLeft">point cloud visualizer   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md135"></a>
ROS bag data migration</h1>
<p>The data file changed from ROS bag to Cyber record in Cyber RT. Cyber RT has a data migration tool <code>rosbag_to_record</code> for users to easily migrate data files before Apollo 3.0 (ROS) to Cyber RT like the sample usage below.</p>
<div class="fragment"><div class="line">rosbag_to_record demo_3.0.bag demo_3.5.record</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
